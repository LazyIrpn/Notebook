name: Convert All Markdown to PDF

on:
  workflow_dispatch:  # onlyæ‰‹åŠ¨è§¦å‘
    inputs:
      directory:
        description: 'æœç´¢ç›®å½• (é»˜è®¤: å…¨ä»“åº“)'
        required: false
        default: '.'
      exclude_pattern:
        description: 'æ’é™¤æ¨¡å¼ (æ­£åˆ™è¡¨è¾¾å¼)'
        required: false
        default: 'node_modules|\.git|\.github|dist|build|vendor'

jobs:
  convert-markdown:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Pandoc and LaTeX
      run: |
        sudo apt-get update
        sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended
        echo "âœ… è½¬æ¢å·¥å…·å®‰è£…å®Œæˆ"
        
    - name: Find all markdown files
      id: find-files
      run: |
        SEARCH_DIR="${{ github.event.inputs.directory || '.' }}"
        EXCLUDE_PATTERN="${{ github.event.inputs.exclude_pattern || 'node_modules|\.git' }}"
        
        # æŸ¥æ‰¾æ‰€æœ‰ .md æ–‡ä»¶
        FILES=$(find "$SEARCH_DIR" -name "*.md" -type f | grep -vE "$EXCLUDE_PATTERN" | sort)
        COUNT=$(echo "$FILES" | wc -l)
        
        echo "ğŸ“„ æ‰¾åˆ° $COUNT ä¸ª Markdown æ–‡ä»¶"
        echo "file_count=$COUNT" >> $GITHUB_OUTPUT
        
        # ä¿å­˜æ–‡ä»¶åˆ—è¡¨åˆ°ä¸´æ—¶æ–‡ä»¶
        echo "$FILES" > /tmp/md_files.txt
        
    - name: Create output directory
      run: |
        mkdir -p generated_pdfs
        echo "ğŸ“ è¾“å‡ºç›®å½•: generated_pdfs/"
        
    - name: Convert to PDF
      if: steps.find-files.outputs.file_count != '0'
      run: |
        echo "ğŸ”„ å¼€å§‹æ‰¹é‡è½¬æ¢..."
        
        TOTAL_FILES=0
        SUCCESS_COUNT=0
        FAILED_FILES=""
        
        while IFS= read -r FILE; do
          if [ -z "$FILE" ]; then continue; fi
          
          TOTAL_FILES=$((TOTAL_FILES + 1))
          echo ""
          echo "--- å¤„ç† [$TOTAL_FILES]: $FILE ---"
          
          # ç”Ÿæˆè¾“å‡ºè·¯å¾„ï¼Œä¿æŒç›®å½•ç»“æ„
          REL_PATH="${FILE#./}"
          PDF_PATH="generated_pdfs/${REL_PATH%.md}.pdf"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p "$(dirname "$PDF_PATH")"
          
          # è½¬æ¢ä¸º PDF
          if pandoc "$FILE" \
            -o "$PDF_PATH" \
            --pdf-engine=xelatex \
            -V geometry:margin=1in \
            -V colorlinks=true \
            -V linkcolor=blue \
            --toc; then
            
            echo "  âœ… ç”Ÿæˆ: $PDF_PATH"
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          else
            echo "  âŒ å¤±è´¥: $FILE"
            FAILED_FILES="$FAILED_FILES\n- $FILE"
          fi
          
        done < /tmp/md_files.txt
        
        echo ""
        echo "ğŸ“Š è½¬æ¢å®Œæˆï¼"
        echo "  æˆåŠŸ: $SUCCESS_COUNT/$TOTAL_FILES"
        
        if [ -n "$FAILED_FILES" ]; then
          echo "  å¤±è´¥çš„æ–‡ä»¶:"
          echo -e "$FAILED_FILES"
          echo "::warning::æœ‰ $(echo -e "$FAILED_FILES" | wc -l) ä¸ªæ–‡ä»¶è½¬æ¢å¤±è´¥"
        fi
        
    - name: Generate index
      run: |
        echo "ğŸ“‹ ç”Ÿæˆç´¢å¼•æ–‡ä»¶..."
        
        cat > generated_pdfs/INDEX.md << 'EOF'
        # ğŸ“„ PDF æ–‡æ¡£ç´¢å¼•
        
        æœ¬ç›®å½•åŒ…å«è‡ªåŠ¨ä» Markdown è½¬æ¢ç”Ÿæˆçš„ PDF æ–‡ä»¶ã€‚
        
        | æ–‡ä»¶ | PDF ç‰ˆæœ¬ | åŸå§‹æ–‡ä»¶ |
        |------|----------|----------|
        EOF
        
        while IFS= read -r FILE; do
          if [ -z "$FILE" ]; then continue; fi
          
          REL_PATH="${FILE#./}"
          PDF_FILE="${REL_PATH%.md}.pdf"
          PDF_PATH="generated_pdfs/$PDF_FILE"
          
          if [ -f "$PDF_PATH" ]; then
            GITHUB_URL="https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/$REL_PATH"
            echo "| $REL_PATH | [ğŸ“¥ ä¸‹è½½]($PDF_FILE) | [ğŸ“„ æŸ¥çœ‹]($GITHUB_URL) |" >> generated_pdfs/INDEX.md
          fi
        done < /tmp/md_files.txt
        
        echo "" >> generated_pdfs/INDEX.md
        echo "**ç”Ÿæˆæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> generated_pdfs/INDEX.md
        echo "**è§¦å‘è€…**: ${{ github.actor }}" >> generated_pdfs/INDEX.md
        
    - name: Upload PDFs as artifact
      uses: actions/upload-artifact@v4
      with:
        name: generated-pdfs
        path: generated_pdfs/
        retention-days: 30
        
    - name: Commit PDFs to repository (å¯é€‰)
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # åªæäº¤ PDF æ–‡ä»¶
        git add generated_pdfs/
        
        if git diff --cached --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
        else
          git commit -m "ğŸ“„ è‡ªåŠ¨ç”Ÿæˆ PDF æ–‡æ¡£ [skip ci]"
          git push
          echo "âœ… PDF æ–‡ä»¶å·²æäº¤åˆ°ä»“åº“"
        fi
